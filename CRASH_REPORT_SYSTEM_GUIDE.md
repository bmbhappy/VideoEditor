# 🔧 崩潰報告系統指南

## 📋 概述

崩潰報告系統是一個完整的應用程式崩潰監控和管理解決方案，能夠自動捕獲、保存和查看應用程式的崩潰信息。

## 🎯 主要功能

### ✅ 自動崩潰捕獲
- **全局異常處理器**：自動捕獲所有未處理的異常
- **多位置保存**：同時保存到多個存儲位置確保不丟失
- **詳細信息記錄**：包含堆疊追蹤、系統信息、記憶體狀態等

### ✅ 崩潰報告管理
- **報告列表**：查看所有歷史崩潰報告
- **詳細查看**：查看完整的崩潰報告內容
- **報告操作**：複製、刪除、清空報告
- **自動清理**：自動清理舊報告，最多保存50個

### ✅ 測試功能
- **模擬崩潰**：測試不同類型的崩潰（OOM、NPE、文件錯誤）
- **手動保存**：手動創建測試報告
- **功能驗證**：驗證崩潰報告系統是否正常工作

## 🛠️ 使用方法

### 1. 訪問崩潰報告功能

**方法一：長按執行日誌按鈕**
- 在主界面長按「執行日誌」按鈕
- 會彈出崩潰報告功能菜單

**方法二：直接啟動**
- 崩潰報告功能會在應用程式啟動時自動初始化
- 當發生崩潰時會自動保存報告

### 2. 崩潰報告菜單選項

```
🔧 崩潰報告功能
├── 查看崩潰報告
├── 測試崩潰報告功能
├── 模擬崩潰 (OOM)
├── 模擬崩潰 (NPE)
├── 模擬崩潰 (文件讀取錯誤)
└── 手動保存崩潰報告
```

### 3. 崩潰報告查看器

**功能按鈕**：
- **重新載入**：重新載入崩潰報告列表
- **清空全部**：刪除所有崩潰報告

**報告操作**：
- **點擊報告**：查看詳細內容
- **複製**：複製報告內容到剪貼板
- **刪除**：刪除單個報告
- **關閉**：關閉詳情對話框

## 📊 崩潰報告內容

每個崩潰報告包含以下信息：

### 🔍 基本信息
- **標題**：崩潰的簡要描述
- **時間**：崩潰發生的具體時間
- **時間戳**：精確的時間戳

### ⚠️ 異常信息
- **類型**：異常的類型（如NullPointerException）
- **消息**：異常的詳細消息

### 📋 堆疊追蹤
- **完整的調用堆疊**：顯示崩潰發生的完整路徑
- **行號信息**：精確定位到代碼行

### 💻 系統信息
- **Android版本**：系統版本號
- **API級別**：Android API級別
- **設備信息**：製造商和型號
- **架構**：CPU架構

### 💾 記憶體信息
- **最大記憶體**：應用程式可用的最大記憶體
- **總記憶體**：當前分配的總記憶體
- **已用記憶體**：當前使用的記憶體
- **可用記憶體**：當前可用的記憶體
- **記憶體使用率**：記憶體使用百分比

## 🔧 技術實現

### 核心組件

#### 1. CrashReportManager
```kotlin
object CrashReportManager {
    // 保存崩潰報告
    fun saveCrashReport(context: Context, title: String, throwable: Throwable)
    
    // 獲取所有崩潰報告
    fun getAllCrashReports(context: Context): List<CrashReport>
    
    // 刪除崩潰報告
    fun deleteCrashReport(report: CrashReport): Boolean
    
    // 清空所有崩潰報告
    fun clearAllCrashReports(context: Context): Int
}
```

#### 2. 全局異常處理器
```kotlin
Thread.setDefaultUncaughtExceptionHandler { thread, throwable ->
    // 記錄早期崩潰信息
    Log.e("CRASH_HANDLER", "應用程式崩潰: ${throwable.message}")
    
    // 保存崩潰報告
    saveCrashReport("應用程式崩潰", throwable)
    
    // 調用默認處理器
    defaultHandler?.uncaughtException(thread, throwable)
}
```

#### 3. CrashReportActivity
- **報告列表顯示**：使用RecyclerView顯示所有報告
- **詳細信息查看**：點擊查看完整報告內容
- **報告管理**：複製、刪除、清空操作

### 存儲策略

#### 多位置保存
1. **應用內部存儲**：`/data/data/com.example.videoeditor/files/crash_reports/`
2. **外部存儲**：`/storage/emulated/0/Android/data/com.example.videoeditor/files/crash_reports/`
3. **下載目錄**：`/storage/emulated/0/Download/VideoEditor_Crash_*.txt`
4. **應用數據目錄**：`/data/data/com.example.videoeditor/crash_reports/`

#### 自動清理
- **最大報告數**：50個
- **清理策略**：按修改時間排序，刪除最舊的報告
- **清理時機**：每次保存新報告時自動清理

## 🧪 測試功能

### 1. 測試崩潰報告功能
- 創建一個測試異常
- 保存測試報告
- 顯示當前報告數量

### 2. 模擬崩潰類型

#### OutOfMemoryError (OOM)
```kotlin
// 嘗試分配大量記憶體來觸發OOM
val list = mutableListOf<ByteArray>()
while (true) {
    list.add(ByteArray(1024 * 1024)) // 1MB
}
```

#### NullPointerException (NPE)
```kotlin
val nullString: String? = null
nullString!!.length // 這會觸發NPE
```

#### 文件讀取錯誤
```kotlin
val nonExistentFile = File("/non/existent/file.txt")
nonExistentFile.readText() // 這會觸發FileNotFoundException
```

### 3. 手動保存崩潰報告
- 創建自定義異常
- 手動保存報告
- 驗證保存功能

## 📱 用戶界面

### 主界面集成
- **隱藏入口**：長按「執行日誌」按鈕
- **功能菜單**：提供多個測試和查看選項
- **無縫集成**：不影響正常使用流程

### 崩潰報告查看器
- **深色主題**：與應用程式主題一致
- **卡片式設計**：清晰的報告列表
- **操作按鈕**：直觀的功能按鈕
- **空狀態**：當沒有報告時的友好提示

### 報告詳情對話框
- **滾動視圖**：支持長內容滾動
- **等寬字體**：便於閱讀代碼和堆疊追蹤
- **操作按鈕**：複製、刪除、關閉

## 🔒 安全考慮

### 數據保護
- **本地存儲**：所有報告僅保存在本地
- **權限控制**：僅在應用程式內部訪問
- **自動清理**：防止報告過多佔用存儲空間

### 隱私保護
- **不收集個人信息**：報告中不包含用戶個人數據
- **可選刪除**：用戶可以隨時刪除報告
- **本地處理**：所有處理都在本地完成

## 🚀 使用建議

### 開發階段
1. **啟用測試功能**：使用模擬崩潰測試系統
2. **監控報告**：定期查看崩潰報告
3. **分析問題**：根據報告信息修復問題

### 生產階段
1. **監控真實崩潰**：收集用戶實際遇到的問題
2. **定期清理**：定期清理舊報告
3. **問題分析**：分析崩潰模式，改進應用程式穩定性

### 調試建議
1. **查看堆疊追蹤**：定位具體的崩潰位置
2. **檢查記憶體狀態**：分析是否為記憶體問題
3. **系統信息對比**：比較不同設備的崩潰情況

## 📝 注意事項

### 使用限制
- **僅捕獲未處理異常**：已處理的異常不會被記錄
- **需要存儲權限**：某些位置需要外部存儲權限
- **報告數量限制**：最多保存50個報告

### 性能影響
- **最小化影響**：異常處理器設計為輕量級
- **異步保存**：報告保存不阻塞主線程
- **自動清理**：防止存儲空間過度使用

### 兼容性
- **Android版本**：支持Android 5.0及以上
- **存儲權限**：根據Android版本自動適配
- **文件系統**：支持各種存儲位置

## 🎉 總結

崩潰報告系統為應用程式提供了完整的崩潰監控和管理能力，幫助開發者：

1. **及時發現問題**：自動捕獲所有崩潰
2. **詳細分析信息**：提供完整的崩潰上下文
3. **方便管理**：易用的報告查看和管理界面
4. **測試驗證**：豐富的測試功能確保系統可靠性

通過這個系統，您可以更好地監控應用程式的穩定性，快速定位和修復問題，提升用戶體驗！🎬✨
